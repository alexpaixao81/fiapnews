<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Not√≠cias</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body>

    <%- include('./partials/navbar') %>

        <div class="container mt-4">
            <h2>Cadastro de Not√≠cias</h2>

            <button class="btn btn-warning mb-3" onclick="abrirModal()">Novo</button>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Descri√ß√£o Resumida</th>
                            <th>Conte√∫do</th>
                            <th>Imagem</th>
                            <th>Visualiza√ß√µes</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="newsTableBody">
                        <!-- As not√≠cias ser√£o carregadas aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal de Cadastro/Atualiza√ß√£o -->
        <div class="modal fade" id="newsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Cadastro de Not√≠cias</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="newsId">
                        <div class="mb-3">
                            <label class="form-label">T√≠tulo</label>
                            <input type="text" class="form-control" id="newsTitle">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o Resumida</label>
                            <input type="text" class="form-control" id="newsShortDescription">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Conte√∫do</label>
                            <textarea class="form-control" id="newsContent"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Imagem</label>

                            <input type="file" class="form-control" id="newsImage" accept="image/*"
                                onchange="previewImage()">

                            <input type="text" class="form-control mt-2" id="newsImageName" readonly>

                            <img id="newsImagePreview" src="" alt="Pr√©via da imagem" width="100"
                                style="display:none; margin-top: 10px;">
                        </div>


                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button class="btn btn-primary" onclick="salvarNoticia()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", carregarNoticias);
        
            function carregarNoticias() {
                fetch('/news')
                    .then(res => res.json())
                    .then(noticias => {
                        let tabela = document.getElementById("newsTableBody");
                        tabela.innerHTML = "";
        
                        noticias.forEach(news => {
                            let imageUrl = news.image && news.image.startsWith('http') 
                                ? news.image 
                                : `/images/${news.image || 'default.jpg'}`; // Usa imagem padr√£o caso n√£o tenha uma
        
                            tabela.innerHTML += `
                                <tr>
                                    <td data-label="T√≠tulo">${news.title}</td>
                                    <td data-label="Descri√ß√£o Resumida">${news.short_description}</td>
                                    <td data-label="Conte√∫do">${news.content}</td>
                                    <td data-label="Imagem">
                                        <img src="${imageUrl}" alt="Imagem" width="50">
                                    </td>                          
                                    <td data-label="Visualiza√ß√µes">${news.views}</td>
                                    <td data-label="A√ß√µes">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-secondary btn-sm" onclick="editarNoticia(${news.id})">Editar</button>
                                            <button class="btn btn-danger btn-sm" onclick="deletarNoticia(${news.id})">Excluir</button>
                                        </div>  
                                    </td>
                                </tr>
                            `;
                        });
                    })
                    .catch(error => console.error("‚ùå Erro ao carregar not√≠cias:", error));
            }
        
            function abrirModal(id = null) {
                const modalElement = document.getElementById("newsModal");
        
                if (!modalElement) {
                    console.error("‚ùå Erro: Modal n√£o encontrado!");
                    return;
                }
        
                document.getElementById("newsId").value = id || "";
                document.getElementById("newsTitle").value = "";
                document.getElementById("newsShortDescription").value = "";
                document.getElementById("newsContent").value = "";
        
                const imageInput = document.getElementById("newsImage");
                const imagePreview = document.getElementById("newsImagePreview");
                const imageNameField = document.getElementById("newsImageName");
        
                if (!id) {
                    // üöÄ Se for novo cadastro, define a imagem padr√£o
                    imageInput.value = "";
                    imagePreview.src = "/images/default.jpg";
                    imagePreview.style.display = "block";
                    imageNameField.value = ""; // Limpa nome do arquivo
                } else {
                    imagePreview.style.display = "none"; 
                    imageNameField.value = "";
                }
        
                new bootstrap.Modal(modalElement).show();
            }
        
            function salvarNoticia() {
                const id = document.getElementById("newsId").value;
                const title = document.getElementById("newsTitle").value;
                const short_description = document.getElementById("newsShortDescription").value;
                const content = document.getElementById("newsContent").value;
                const imageInput = document.getElementById("newsImage");
                const existingImage = document.getElementById("newsImageName").value; // Nome do arquivo salvo
        
                const formData = new FormData();
                formData.append("title", title);
                formData.append("short_description", short_description);
                formData.append("content", content);
        
                // Se um novo arquivo for selecionado, substitui a imagem
                if (imageInput.files.length > 0) {
                    formData.append("image", imageInput.files[0]);
                } else if (existingImage) {
                    formData.append("image", existingImage); // Mant√©m a imagem antiga se n√£o houver altera√ß√£o
                }
        
                const url = id ? `/news/${id}` : "/news";
                const method = id ? "PUT" : "POST";
        
                fetch(url, {
                    method,
                    body: formData
                })
                .then(res => res.json())
                .then(() => {
                    carregarNoticias();
                    bootstrap.Modal.getInstance(document.getElementById("newsModal")).hide();
                })
                .catch(error => console.error("‚ùå Erro ao salvar not√≠cia:", error));
            }
        
            function editarNoticia(id) {
                fetch(`/news/${id}`)
                    .then(res => res.json())
                    .then(noticia => {
                        console.log("üì¢ Dados carregados para edi√ß√£o:", noticia);
        
                        document.getElementById("newsId").value = noticia.id;
                        document.getElementById("newsTitle").value = noticia.title;
                        document.getElementById("newsShortDescription").value = noticia.short_description;
                        document.getElementById("newsContent").value = noticia.content;
        
                        const imagePreview = document.getElementById("newsImagePreview");
                        const imageNameField = document.getElementById("newsImageName");
        
                        if (noticia.image) {
                            imageNameField.value = noticia.image;
                            imagePreview.src = `/images/${noticia.image}`;
                            imagePreview.style.display = "block";
                        } else {
                            imageNameField.value = "";
                            imagePreview.style.display = "none";
                        }
        
                        new bootstrap.Modal(document.getElementById("newsModal")).show();
                    })
                    .catch(error => console.error("‚ùå Erro ao carregar not√≠cia:", error));
            }
        
            function deletarNoticia(id) {
                if (confirm("Tem certeza que deseja excluir?")) {
                    fetch(`/news/${id}`, { method: "DELETE" })
                        .then(() => carregarNoticias())
                        .catch(error => console.error("‚ùå Erro ao excluir not√≠cia:", error));
                }
            }
        
            function previewImage() {
                const imageInput = document.getElementById("newsImage");
                const imagePreview = document.getElementById("newsImagePreview");
        
                if (imageInput.files.length > 0) {
                    const file = imageInput.files[0];
                    const reader = new FileReader();
        
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = "block";
                    };
        
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = "/images/default.jpg";
                }
            }
        </script>
        

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>